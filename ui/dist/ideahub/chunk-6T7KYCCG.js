import{a as T}from"./chunk-BB75FWJ4.js";import{n as d,t as k}from"./chunk-73XDKHC7.js";import{A as s,G as h,Q as n,U as p,Y as m,Z as f,j as g,m as u,n as a}from"./chunk-IXVHFNYV.js";var b=class i{constructor(o){this.http=o;let e=localStorage.getItem("accessToken");this._isLoggedIn.next(!!e)}router=f(k);authUrl=`${T.apiUrl}/auth`;_isLoggedIn=new g(!1);isLoggedIn$=this._isLoggedIn.asObservable();register(o){return console.log("Registration taking place..."),this.http.post(`${this.authUrl}/register`,o).pipe(n(e=>{console.log(`${o.email} has registered successfully: `,e)}),s(e=>{throw new Error(`Registration failed: ${e}`)}))}login(o){return this.http.post(`${this.authUrl}/login`,o).pipe(n(e=>{if(e.status&&e.data?.accessToken)localStorage.setItem("accessToken",e.data.accessToken),localStorage.setItem("refreshToken",e.data.refreshToken),localStorage.setItem("refreshTokenExpiry",e.data.refreshTokenExpiry),this._isLoggedIn.next(!0);else throw new Error(e.message||"Login failed")}),s(e=>{throw new Error(`Login failed: ${e.message}`)}))}logout(){return console.log("User logging out..."),this.isTokenValid()?this.http.post(`${this.authUrl}/logout`,{}).pipe(n(()=>{console.log("Server logout successful")}),s(o=>(console.error("Server logout failed, forcing local logout",o),a(()=>o))),h(()=>{this.logoutLocal()})):(console.log("Token expired or invalid, performing local logout only."),this.logoutLocal(),u(!0))}refreshToken(){let o=localStorage.getItem("accessToken"),e=localStorage.getItem("refreshToken");if(!o||!e)return this.logoutLocal(),a(()=>new Error("No tokens found"));let r={accessToken:o,refreshToken:e};return this.http.post(`${this.authUrl}/refresh-token`,r).pipe(n(t=>{let l=t.accessToken||t.AccessToken,c=t.refreshToken||t.RefreshToken;l&&c?(localStorage.setItem("accessToken",l),localStorage.setItem("refreshToken",c),this._isLoggedIn.next(!0),console.log("Token refreshed successfully")):console.warn("Refresh succeeded but tokens were missing in response",t)}),s(t=>(console.error("Token refresh failed",t),this.logoutLocal(),a(()=>t))))}logoutLocal(){localStorage.removeItem("accessToken"),localStorage.removeItem("refreshToken"),localStorage.removeItem("refreshTokenExpiry"),this._isLoggedIn.next(!1),this.router.navigate(["/"])}isTokenValid(){let o=localStorage.getItem("accessToken");if(!o)return!1;try{let e=o.split(".");if(e.length!==3)return!1;let r=JSON.parse(atob(e[1]));if(!r.exp)return!1;let t=r.exp*1e3;return Date.now()<t}catch{return!1}}isLoggedIn(){return!!localStorage.getItem("accessToken")}getCurrentUser(){let o=localStorage.getItem("accessToken");if(!o)return null;try{let e=JSON.parse(atob(o.split(".")[1]));return{id:e.sub||e.nameid||e["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier"],email:e.email||e["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"],roles:e.role||e["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"]||[]}}catch{return null}}getCurrentUserRoles(){return this.getCurrentUser()?.roles||[]}hasRole(o){return this.getCurrentUserRoles().some(r=>r===o||r.toLowerCase()===o.toLowerCase())}isSuperAdmin(){return this.hasRole("SuperAdmin")||this.hasRole("SUPERADMIN")}isGroupAdmin(){return this.hasRole("GroupAdmin")||this.hasRole("GROUPADMIN")}isRegularUser(){return this.hasRole("RegularUser")||this.hasRole("REGULARUSER")}hasAnyRole(o){return o.some(e=>this.hasRole(e))}getCurrentUserId(){return this.getCurrentUser()?.id||""}static \u0275fac=function(e){return new(e||i)(m(d))};static \u0275prov=p({token:i,factory:i.\u0275fac,providedIn:"root"})};export{b as a};
